<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>P2P Chat Modern</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³ï¼šãƒ¢ãƒ€ãƒ³ï¼‹ã¡ã‚‡ã„éŠã³å¿ƒ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body {
    margin: 0;
    min-height: 100vh;
    background: radial-gradient(circle at 10% 20%, #f8cdda 0, #1d2b64 60%, #141e30 100%);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    padding: 12px 10px 20px;
    box-sizing: border-box;
}

/* ã‚«ãƒ¼ãƒ‰å…±é€š */
.card {
    width: 100%;
    max-width: 460px;
    background: rgba(255,255,255,0.10);
    border-radius: 22px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.45);
    backdrop-filter: blur(24px);
    border: 1px solid rgba(255,255,255,0.18);
    padding: 20px 18px 18px;
    animation: fadeIn 0.45s ease;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    margin: 10px auto;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px) scale(0.98); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
}

/* ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ† */
.title-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 8px;
}
.title-accent {
    width: 26px;
    height: 26px;
    border-radius: 999px;
    background: conic-gradient(from 200deg, #ff9a9e, #fad0c4, #fbc2eb, #a6c1ee, #ff9a9e);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 14px;
}
h2 {
    margin: 0;
    text-align: center;
    font-weight: 600;
    color: #f9fafb;
    letter-spacing: 0.03em;
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ« */
.status-pill {
    align-self: center;
    margin: 6px 0 10px;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 12px;
    color: #e5ecff;
    background: rgba(15,118,255,0.16);
    border: 1px solid rgba(144,202,249,0.4);
}

/* ãƒœã‚¿ãƒ³ */
button {
    width: 100%;
    padding: 11px;
    margin-top: 10px;
    border-radius: 14px;
    border: none;
    background: linear-gradient(135deg, #4f46e5, #22d3ee);
    color: white;
    font-size: 15px;
    cursor: pointer;
    transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    box-shadow: 0 6px 14px rgba(15,23,42,0.45);
}
button:hover {
    filter: brightness(1.05);
    transform: translateY(-1px);
    box-shadow: 0 10px 20px rgba(15,23,42,0.6);
}
button:active {
    transform: translateY(0);
    box-shadow: 0 4px 10px rgba(15,23,42,0.5);
}

/* ã‚µãƒ–ãƒœã‚¿ãƒ³ */
.small-btn {
    margin-top: 6px;
    padding: 8px;
    width: 49%;
    border-radius: 12px;
    font-size: 12px;
    background: rgba(15,23,42,0.75);
    box-shadow: none;
}
.small-btn:hover {
    background: rgba(15,23,42,0.9);
    box-shadow: none;
}

/* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
textarea, input {
    width: 100%;
    padding: 9px 10px;
    margin-top: 6px;
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,0.8);
    background: rgba(15,23,42,0.65);
    color: #e5e7eb;
    outline: none;
    font-size: 13px;
    box-sizing: border-box;
}
textarea::placeholder,
input::placeholder {
    color: rgba(148,163,184,0.9);
}

/* ãƒ©ãƒ™ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ */
.label {
    font-size: 13px;
    color: #e5e7eb;
    margin-top: 6px;
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ–‡å­— */
#status, #status2, #status3 {
    text-align: center;
    color: #e5ecff;
    font-weight: 500;
    font-size: 13px;
}

/* ãƒãƒ£ãƒƒãƒˆç”»é¢å°‚ç”¨èª¿æ•´ */
.chat-card {
    display: flex;
    flex-direction: column;
}

/* ãƒãƒ£ãƒƒãƒˆæ¬„ */
#chat {
    flex: 1 1 auto;
    background: linear-gradient(135deg, rgba(15,23,42,0.7), rgba(30,64,175,0.7));
    border-radius: 16px;
    padding: 10px;
    overflow-y: auto;
    margin: 10px 0;
    border: 1px solid rgba(148,163,184,0.4);
    box-sizing: border-box;
    min-height: 220px;
    max-height: 60vh; /* ç”»é¢ã®6å‰²ãã‚‰ã„ã¾ã§ã«æŠ‘ãˆã‚‹ */
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¹ãå‡ºã— */
.msg {
    margin: 6px 0;
    padding: 8px 11px;
    border-radius: 14px;
    max-width: 80%;
    animation: msgPop 0.2s ease;
    font-size: 13px;
}
@keyframes msgPop {
    from { opacity: 0; transform: translateY(4px) scale(0.98); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
}
.msg.me {
    margin-left: auto;
    background: linear-gradient(135deg, #4f46e5, #22d3ee);
    color: #f9fafb;
}
.msg.other {
    background: rgba(15,23,42,0.85);
    color: #e5e7eb;
}
.msg.system {
    margin: 4px auto;
    text-align: center;
    background: transparent;
    color: #cbd5f5;
    font-size: 11px;
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã®ç”»åƒ */
.msg img {
    max-width: 100%;
    border-radius: 10px;
    margin-top: 4px;
}

/* ãƒ•ã‚¡ã‚¤ãƒ«ãƒªãƒ³ã‚¯ */
.file-link {
    color: #bfdbfe;
    text-decoration: underline;
    word-break: break-all;
    font-size: 12px;
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›è¡Œï¼ˆæ¨ªä¸¦ã³ï¼‰ */
#msgRow {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 4px;
}
#msg {
    flex: 1;
    margin-top: 0;
}
#send {
    width: auto;
    min-width: 78px;
    margin-top: 0;
    padding-inline: 12px;
    font-size: 13px;
}

/* ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡è¡Œ */
#fileRow {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 6px;
}
#fileInput {
    flex: 1;
    padding: 6px 8px;
    font-size: 11px;
    background: rgba(15,23,42,0.65);
    border-radius: 12px;
    border: 1px solid rgba(148,163,184,0.8);
    color: #e5e7eb;
}
#sendFile {
    width: auto;
    min-width: 84px;
    margin-top: 0;
    padding-inline: 10px;
    font-size: 11px;
}

/* å…±é€š */
.hidden { display: none; }

/* ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆå›ºå®šã¯ã‚„ã‚ã‚‹ï¼‰ */
.footer {
    margin-top: 8px;
    text-align: center;
    font-size: 11px;
    color: rgba(241,245,249,0.7);
    letter-spacing: 0.04em;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PCæ™‚ã ã‘ä¸­å¤®å¯„ã› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (min-width: 768px) {
    body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 16px;
    }
}
</style>
</head>
<body>

<!-- â˜… æœ€åˆã®é¸æŠç”»é¢ -->
<div class="card" id="selectScreen">
    <div class="title-row">
        <div class="title-accent">ğŸ’¬</div>
        <h2>P2P Chat</h2>
    </div>
    <div class="status-pill">ã‚µãƒ¼ãƒãƒ¼ãªã—ãƒ»å±¥æ­´ãªã—ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶åŒå£«ã§ç›´çµ</div>
    <button onclick="selectHost()">ãƒ›ã‚¹ãƒˆã¨ã—ã¦é–‹å§‹</button>
    <button onclick="selectGuest()">ã‚²ã‚¹ãƒˆã¨ã—ã¦å‚åŠ </button>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒ›ã‚¹ãƒˆç”»é¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card hidden" id="hostScreen">
    <div class="title-row">
        <div class="title-accent">ğŸ›°</div>
        <h2>ãƒ›ã‚¹ãƒˆ</h2>
    </div>
    <div class="status-pill">ã‚ãªãŸãŒãƒ«ãƒ¼ãƒ ã‚’ç«‹ã¦ã¾ã™</div>
    <div id="status">ã€Œæ¥ç¶šã‚³ãƒ¼ãƒ‰ç”Ÿæˆã€ã‚’æŠ¼ã—ã¦ã€å‡ºã¦ããŸã‚³ãƒ¼ãƒ‰ã‚’ç›¸æ‰‹ã«é€ã£ã¦ãã ã•ã„ã€‚</div>

    <div class="label">1. æ¥ç¶šã‚³ãƒ¼ãƒ‰ï¼ˆOfferï¼‰ã‚’ä½œæˆ</div>
    <button id="createOffer">æ¥ç¶šã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</button>
    <textarea id="offer" rows="4" placeholder="ç”Ÿæˆã•ã‚ŒãŸæ¥ç¶šã‚³ãƒ¼ãƒ‰ï¼ˆOfferï¼‰ãŒã“ã“ã«å‡ºã¾ã™"></textarea>

    <div style="display:flex; justify-content:space-between;">
        <button class="small-btn" onclick="copyText('offer')">Offerã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="small-btn" onclick="pasteText('hostAnswer')">Answerã‚’ãƒšãƒ¼ã‚¹ãƒˆ</button>
    </div>

    <div class="label">2. ã‚²ã‚¹ãƒˆã‹ã‚‰å±Šã„ãŸ Answer ã‚’è²¼ã‚‹</div>
    <textarea id="hostAnswer" rows="4" placeholder="ã‚²ã‚¹ãƒˆã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸAnswerã‚’ã“ã“ã«è²¼ã‚‹"></textarea>
    <button id="applyAnswer">Answerã‚’é©ç”¨ã—ã¦æ¥ç¶šé–‹å§‹</button>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚²ã‚¹ãƒˆç”»é¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card hidden" id="guestScreen">
    <div class="title-row">
        <div class="title-accent">ğŸ“¡</div>
        <h2>ã‚²ã‚¹ãƒˆ</h2>
    </div>
    <div class="status-pill">ãƒ›ã‚¹ãƒˆã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’ã‚‚ã‚‰ã£ã¦æ¥ç¶šã—ã¾ã™</div>
    <div id="status2">ãƒ›ã‚¹ãƒˆã‹ã‚‰é€ã‚‰ã‚ŒãŸOfferã‚’è²¼ã£ã¦ãã ã•ã„ã€‚</div>

    <div class="label">1. ãƒ›ã‚¹ãƒˆã® Offer ã‚’è²¼ã‚‹</div>
    <textarea id="answer" rows="4" placeholder="ãƒ›ã‚¹ãƒˆã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸOfferã‚’ã“ã“ã«è²¼ã‚‹"></textarea>

    <div style="display:flex; justify-content:space-between;">
        <button class="small-btn" onclick="pasteText('answer')">Offerã‚’ãƒšãƒ¼ã‚¹ãƒˆ</button>
    </div>

    <div class="label">2. Answer ã‚’ç”Ÿæˆã—ã¦ã€ãƒ›ã‚¹ãƒˆã«é€ã‚Šè¿”ã™</div>
    <button id="setAnswer">Answerç”Ÿæˆ</button>

    <textarea id="guestAnswerOut" rows="4" placeholder="ç”Ÿæˆã•ã‚ŒãŸAnswerãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆã“ã‚Œã‚’ãƒ›ã‚¹ãƒˆã«é€ã‚‹ï¼‰"></textarea>

    <div style="display:flex; justify-content:space-between;">
        <button class="small-btn" onclick="copyText('guestAnswerOut')">Answerã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒãƒ£ãƒƒãƒˆç”»é¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card chat-card hidden" id="chatScreen">
    <div class="title-row">
        <div class="title-accent">âœ¨</div>
        <h2>ãƒãƒ£ãƒƒãƒˆ</h2>
    </div>
    <div class="status-pill" id="status3">æ¥ç¶šä¸­â€¦</div>

    <div id="chat"></div>

    <div id="msgRow">
        <input id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ï¼ˆEnterã§é€ä¿¡ / Shift+Enterã§æ”¹è¡Œï¼‰">
        <button id="send">é€ä¿¡</button>
    </div>

    <div id="fileRow">
        <input type="file" id="fileInput" multiple>
        <button id="sendFile">ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡</button>
    </div>
</div>

<!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
<div class="footer">
    taiboku_passent all right reserved
</div>

<script>
let pc;
let channel;
let disconnected = false;

// å—ä¿¡ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ç”¨
let incomingFileMeta = null;
let incomingFileChunks = [];
let incomingReceivedBytes = 0;

const MAX_FILE_SIZE = 15 * 1024 * 1024; // 15MBãã‚‰ã„ã¾ã§

/* ===== DOMå–å¾— ===== */
const selectScreen   = document.getElementById("selectScreen");
const hostScreen     = document.getElementById("hostScreen");
const guestScreen    = document.getElementById("guestScreen");
const chatScreen     = document.getElementById("chatScreen");

const status1        = document.getElementById("status");
const status2        = document.getElementById("status2");
const status3        = document.getElementById("status3");

const offerTextarea        = document.getElementById("offer");
const hostAnswerTextarea   = document.getElementById("hostAnswer");
const guestOfferTextarea   = document.getElementById("answer");
const guestAnswerOutTextarea = document.getElementById("guestAnswerOut");

const createOfferBtn = document.getElementById("createOffer");
const applyAnswerBtn = document.getElementById("applyAnswer");
const setAnswerBtn   = document.getElementById("setAnswer");

const chatDiv   = document.getElementById("chat");
const msgInput  = document.getElementById("msg");
const sendBtn   = document.getElementById("send");

const fileInput   = document.getElementById("fileInput");
const sendFileBtn = document.getElementById("sendFile");

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function copyText(id) {
    const text = document.getElementById(id).value;
    if (!text) { alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
            .then(() => alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"))
            .catch(() => alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ"));
    } else {
        const el = document.getElementById(id);
        el.select();
        document.execCommand("copy");
        alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆæ—§APIï¼‰");
    }
}

async function pasteText(id) {
    if (!(navigator.clipboard && navigator.clipboard.readText)) {
        alert("ã“ã®ç’°å¢ƒã§ã¯ãƒšãƒ¼ã‚¹ãƒˆAPIãŒä½¿ãˆã¾ã›ã‚“ã€‚æ‰‹å‹•ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
        return;
    }
    try {
        const text = await navigator.clipboard.readText();
        document.getElementById(id).value = text;
    } catch (e) {
        alert("ãƒšãƒ¼ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RTCåˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initRTC() {
    pc = new RTCPeerConnection({
        iceServers: [] // å¿…è¦ãªã‚‰ STUN ã‚µãƒ¼ãƒãƒ¼ã‚’è¿½åŠ 
    });

    pc.ondatachannel = ev => {
        channel = ev.channel;
        setupChannel();
    };

    pc.onconnectionstatechange = () => {
        if (!pc) return;
        const st = pc.connectionState;
        if (["disconnected", "failed", "closed"].includes(st)) {
            handleDisconnect();
        }
    };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ¥ç¶šåˆ‡ã‚Œå‡¦ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleDisconnect() {
    if (disconnected) return;
    disconnected = true;

    if (!chatScreen.classList.contains("hidden")) {
        status3.textContent = "æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ";
    }

    setTimeout(() => {
        resetApp();
    }, 1200);
}

function resetApp() {
    if (channel) {
        try { channel.close(); } catch(e) {}
        channel = null;
    }
    if (pc) {
        try { pc.close(); } catch(e) {}
        pc = null;
    }
    disconnected = false;

    incomingFileMeta = null;
    incomingFileChunks = [];
    incomingReceivedBytes = 0;

    hostScreen.classList.add("hidden");
    guestScreen.classList.add("hidden");
    chatScreen.classList.add("hidden");
    selectScreen.classList.remove("hidden");

    offerTextarea.value = "";
    hostAnswerTextarea.value = "";
    guestOfferTextarea.value = "";
    guestAnswerOutTextarea.value = "";
    chatDiv.innerHTML = "";
    msgInput.value = "";
    fileInput.value = "";

    status1.textContent = "ã€Œæ¥ç¶šã‚³ãƒ¼ãƒ‰ç”Ÿæˆã€ã‚’æŠ¼ã—ã¦ã€å‡ºã¦ããŸã‚³ãƒ¼ãƒ‰ã‚’ç›¸æ‰‹ã«é€ã£ã¦ãã ã•ã„ã€‚";
    status2.textContent = "ãƒ›ã‚¹ãƒˆã‹ã‚‰é€ã‚‰ã‚ŒãŸOfferã‚’è²¼ã£ã¦ãã ã•ã„ã€‚";
    status3.textContent = "æ¥ç¶šä¸­â€¦";
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç”»é¢åˆ‡æ›¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function selectHost() {
    resetApp();
    initRTC();
    selectScreen.classList.add("hidden");
    hostScreen.classList.remove("hidden");
}
function selectGuest() {
    resetApp();
    initRTC();
    selectScreen.classList.add("hidden");
    guestScreen.classList.remove("hidden");
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒ›ã‚¹ãƒˆï¼šOfferç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
createOfferBtn.onclick = async () => {
    channel = pc.createDataChannel("chat");
    setupChannel();

    status1.textContent = "æ¥ç¶šã‚³ãƒ¼ãƒ‰ç”Ÿæˆä¸­â€¦";

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    pc.onicecandidate = e => {
        if (!e.candidate) {
            offerTextarea.value = JSON.stringify(pc.localDescription);
            status1.textContent = "Offerã‚’ã‚²ã‚¹ãƒˆã«é€ã£ã¦ãã ã•ã„ã€‚";
        }
    };
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒ›ã‚¹ãƒˆï¼šAnswerå—ä¿¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
applyAnswerBtn.onclick = async () => {
    const text = hostAnswerTextarea.value.trim();
    if (!text) { alert("AnswerãŒç©ºã§ã™"); return; }

    try {
        const ans = JSON.parse(text);
        await pc.setRemoteDescription(ans);
        status1.textContent = "Answerã‚’é©ç”¨ã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’å¾…æ©Ÿä¸­â€¦";
    } catch (e) {
        alert("Answerã®å½¢å¼ãŒä¸æ­£ã§ã™");
    }
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚²ã‚¹ãƒˆï¼šOfferâ†’Answerç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
setAnswerBtn.onclick = async () => {
    const text = guestOfferTextarea.value.trim();
    if (!text) { alert("OfferãŒç©ºã§ã™"); return; }

    try {
        const remoteOffer = JSON.parse(text);
        await pc.setRemoteDescription(remoteOffer);
    } catch (e) {
        alert("Offerã®å½¢å¼ãŒä¸æ­£ã§ã™");
        return;
    }

    status2.textContent = "Answerç”Ÿæˆä¸­â€¦";

    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);

    pc.onicecandidate = e => {
        if (!e.candidate) {
            guestAnswerOutTextarea.value = JSON.stringify(pc.localDescription);
            status2.textContent = "ç”Ÿæˆã•ã‚ŒãŸAnswerã‚’ãƒ›ã‚¹ãƒˆã«æ¸¡ã—ã¦ãã ã•ã„ã€‚";
        }
    };
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DataChannel / ãƒãƒ£ãƒƒãƒˆå‡¦ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setupChannel() {
    incomingFileMeta = null;
    incomingFileChunks = [];
    incomingReceivedBytes = 0;

    channel.binaryType = "arraybuffer";

    channel.onopen = () => {
        hostScreen.classList.add("hidden");
        guestScreen.classList.add("hidden");
        chatScreen.classList.remove("hidden");
        status3.textContent = "æ¥ç¶šå®Œäº† âœ”";
    };

    channel.onmessage = handleDataMessage;
    channel.onclose   = () => handleDisconnect();
}

/* å—ä¿¡ãƒ‡ãƒ¼ã‚¿å‡¦ç† */
function handleDataMessage(e) {
    const data = e.data;

    if (typeof data === "string") {
        // ãƒ¡ã‚¿ã‹é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹
        try {
            const obj = JSON.parse(data);
            if (obj && obj.kind === "file-meta") {
                incomingFileMeta = obj;
                incomingFileChunks = [];
                incomingReceivedBytes = 0;
                addSystemMsg(`ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡ä¸­: ${obj.name} (${Math.round(obj.size/1024)}KB)`);
                return;
            }
        } catch {
            // æ™®é€šã®ãƒ†ã‚­ã‚¹ãƒˆ
        }
        addMsg(data, "other");
        return;
    }

    // ãƒã‚¤ãƒŠãƒªï¼ˆãƒãƒ£ãƒ³ã‚¯ï¼‰
    if (!incomingFileMeta) {
        addSystemMsg("ä¸æ˜ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã¾ã—ãŸ");
        return;
    }

    const chunk = data;
    const len = (chunk && (chunk.byteLength ?? chunk.size)) || 0;

    incomingFileChunks.push(chunk);
    incomingReceivedBytes += len;

    if (incomingReceivedBytes >= incomingFileMeta.size) {
        const blob = new Blob(incomingFileChunks, {
            type: incomingFileMeta.type || "application/octet-stream"
        });
        const url = URL.createObjectURL(blob);
        addFileMsg(url, incomingFileMeta, "other");

        incomingFileMeta = null;
        incomingFileChunks = [];
        incomingReceivedBytes = 0;
    }
}

/* ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ */
sendBtn.onclick = () => {
    const text = msgInput.value;
    if (!text || !channel || channel.readyState !== "open") return;
    channel.send(text);
    addMsg(text, "me");
    msgInput.value = "";
};

/* ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡ï¼ˆè¤‡æ•°å¯¾å¿œï¼‹ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ï¼‰ */
sendFileBtn.onclick = async () => {
    if (!channel || channel.readyState !== "open") {
        alert("æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        return;
    }
    const files = Array.from(fileInput.files || []);
    if (!files.length) {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
    }

    for (const file of files) {
        await sendOneFile(file);
    }
    fileInput.value = "";
};

function sendOneFile(file) {
    return new Promise((resolve) => {
        if (file.size > MAX_FILE_SIZE) {
            alert(`ã€Œ${file.name}ã€ãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§ ç´„${Math.round(MAX_FILE_SIZE/1024/1024)}MBã¾ã§ï¼‰ã€‚`);
            return resolve();
        }

        const meta = {
            kind: "file-meta",
            name: file.name,
            type: file.type,
            size: file.size
        };

        // ãƒ¡ã‚¿æƒ…å ±ã‚’å…ˆã«é€ä¿¡
        channel.send(JSON.stringify(meta));

        const reader = new FileReader();
        reader.onload = () => {
            const buffer = reader.result; // ArrayBuffer
            const chunkSize = 16 * 1024; // 16KBãšã¤é€ä¿¡

            for (let offset = 0; offset < buffer.byteLength; offset += chunkSize) {
                const slice = buffer.slice(offset, offset + chunkSize);
                channel.send(slice);
            }

            // è‡ªåˆ†å´ã«ã‚‚è¡¨ç¤º
            const blob = new Blob([buffer], {
                type: file.type || "application/octet-stream"
            });
            const url = URL.createObjectURL(blob);
            addFileMsg(url, meta, "me");

            resolve();
        };
        reader.onerror = () => {
            alert(`ã€Œ${file.name}ã€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ`);
            resolve();
        };
        reader.readAsArrayBuffer(file);
    });
}

/* Enterã§é€ä¿¡ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰ */
msgInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
    }
});

/* è¡¨ç¤ºç³» */
function addMsg(text, type) {
    const div = document.createElement("div");
    div.className = "msg " + type;
    div.textContent = text;
    chatDiv.appendChild(div);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

function addSystemMsg(text) {
    const div = document.createElement("div");
    div.className = "msg system";
    div.textContent = text;
    chatDiv.appendChild(div);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

function addFileMsg(url, meta, type) {
    const div = document.createElement("div");
    div.className = "msg " + type;

    const name = document.createElement("div");
    name.textContent = meta.name;
    name.style.fontWeight = "600";
    name.style.fontSize = "12px";
    div.appendChild(name);

    if (meta.type && meta.type.startsWith("image/")) {
        const img = document.createElement("img");
        img.src = url;
        img.alt = meta.name;
        div.appendChild(img);
    }

    const a = document.createElement("a");
    a.href = url;
    a.download = meta.name;
    a.textContent = "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
    a.className = "file-link";
    div.appendChild(a);

    chatDiv.appendChild(div);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

/* ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‹ã‚‰ä½¿ã†é–¢æ•°ï¼ˆãƒœã‚¿ãƒ³ã®onclickç”¨ï¼‰ */
function selectHost() {
    resetApp();
    initRTC();
    selectScreen.classList.add("hidden");
    hostScreen.classList.remove("hidden");
}
function selectGuest() {
    resetApp();
    initRTC();
    selectScreen.classList.add("hidden");
    guestScreen.classList.remove("hidden");
}
</script>

</body>
</html>
